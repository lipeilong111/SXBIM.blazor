@page "/download"
@using SXBIM_Login.Controller
@using System.Text.Json
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject HttpClient Http

<title>三鑫插件下载中心</title>
<style>
    body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        background-color: #fafafa;
        color: #111827;
        padding-top: 72px; /* 根据 header 高度设定 */
    }

    .download-header {
        background-color: #ffffff;
        color: #111827;
        padding: 60px 20px;
        text-align: center;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
        overflow: hidden;
        z-index: 0; /* 确保在普通元素层级 */
    }

        .download-header::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: 1;
            background-image:
            /* 横向线条 */
            linear-gradient(to right, rgba(0, 0, 0, 0.08) 1px, transparent 1px),
            /* 纵向线条 */
            linear-gradient(to bottom, rgba(0, 0, 0, 0.08) 1px, transparent 1px),
            /* 烟雾 */
            radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.1), transparent 60%), radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.03), transparent 70%);
            background-size: 60px 60px, 60px 60px, 300px 300px, 400px 400px;
            background-repeat: repeat;
            pointer-events: none;
        }

        .download-header h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 600;
        }

        .download-header p {
            font-size: 16px;
            margin-top: 10px;
            color: #6b7280;
        }

    .download-button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #f9f9f9;
        color: #111827;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        z-index: 2;
        position: relative;
        font-weight: bold;
    }

        .download-button:hover {
            background-color: #f3f4f6;
        }

    .section {
        display: flex;
        justify-content: center;
        gap: 45px;
        padding: 40px 20px;
        flex-wrap: wrap;
        background-color: #fafafa;
    }

    .card {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 24px;
        width: 320px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: box-shadow 0.2s ease;
    }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .card h3 {
            color: #111827;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            gap: 12px; /* 徽章和标题之间的间距 */
            display: flex;
        }

        .card p {
            font-size: 14px;
            color: #374151;
            margin: 6px 0;
            line-height: 1.6;
        }

    .platform {
        margin-top: auto;
        font-weight: 500;
        font-size: 13px;
        color: #6b7280;
    }

    .spacer {
        flex-grow: 1;
    }

    .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 16px;
    }

        .button-group button {
            flex: 1;
            margin: 0 4px;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background-color: #f9f9f9;
            color: #111827;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

            .button-group button:hover {
                background-color: #f3f4f6;
                transform: scale(1.02);
            }

    .badge {
        width: 24px;
        height: 24px;
        background-color: #111; /* 黑色背景 */
        color: #fff; /* 白色文字 */
        border-radius: 50%; /* 圆形 */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
    }
</style>
<header class="download-header">
    <h1>三鑫插件下载中心</h1>
    <p>一站式获取三鑫 BIM 工具插件，助力设计与出图效率</p>
    <button class="download-button" @onclick="GoToSXGZL">了解三鑫插件生态</button>
</header>

<div class="section">
    <div class="card">
        <h3>
            <span class="badge">1</span>
            SX_Cad
        </h3>
        <p>一款基于 CAD 的智能设计插件，实现 CAD 与 Rhino 模型及信息的高效互通，快速出图，提升团队协同效率</p>
        <div class="spacer"></div>
        <p class="platform">
            <strong>支持平台：</strong>CAD 2012-2024
            <br />
            <strong>当前版本：</strong>@($"V{cadVersion}")
            <br />
            <strong>更新日期：</strong>@cadUpdateDate
        </p>
        <p>
        </p>
        <div class="button-group">
            <button @onclick="GoToDocs">文档</button>
            <button @onclick="downloadCAD">下载</button>
        </div>
    </div>

    <div class="card">
        <h3>
            <span class="badge">2</span>SX_Snail
        </h3>
        <p>一款基于 Rhino & Grasshopper 的智能建模插件，实现加工图自动生成、构件自动编号、材料清单提取，让设计与制造高效衔接</p>
        <div class="spacer"></div>
        <p class="platform">
            <strong>支持平台：</strong>Rhino 7.4+ / Grasshopper
            <br />
            <strong>当前版本：</strong>@($"V{rhinoVersion}")
            <br />
            <strong>更新日期：</strong>@rhinoUpdateDate
        </p>
        <p>
        </p>
        <div class="button-group">
            <button @onclick="GoToDocs">文档</button>
            <button @onclick="DownloadMultiple">下载</button>
        </div>
    </div>

    <div class="card">
        <h3>
            <span class="badge">3</span>SX_Revit
        </h3>
        <p>一款基于 Revit 平台，打通Rhino与Revit的双向通道，支持正向设计流转，实现参数化设计与 BIM 出图的无缝衔接</p>
        <div class="spacer"></div>
        <p class="platform">
            <strong>支持平台：</strong>Revit 2020
            <br />
            <strong>当前版本：</strong>@($"V{revitVersion}")
            <br />
            <strong>更新日期：</strong>@revitUpdateDate
        </p>
        <p>
        </p>
        <div class="button-group">
            <button @onclick="GoToDocs">文档</button>
            <button @onclick="downloadRevit">下载</button>
        </div>
    </div>
</div>

@code {
    private bool _checked = false;

    private string cadVersion = "";
    private string cadUpdateDate = "";

    private string rhinoVersion = "";
    private string rhinoUpdateDate = "";

    private string revitVersion = "";
    private string revitUpdateDate = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_checked)
        {
            _checked = true;

            var isLoggedIn = await JS.InvokeAsync<string>("sessionStorage.getItem", "isLoggedIn");
            if (isLoggedIn != "true")
            {
#if DEBUG
#else
                Nav.NavigateTo("/login", true);
#endif
            }

            await LoadPluginInfo("cad");
            await LoadPluginInfo("rhino");
            await LoadPluginInfo("revit");
            StateHasChanged();
        }

    }



    private async Task DownloadMultiple()
    {
        await JS.InvokeVoidAsync("downloadMultipleFiles");
        await WriteDownloadLog("rhino");
    }
    private async Task downloadCAD()
    {
        await JS.InvokeVoidAsync("downloadCAD");
        await WriteDownloadLog("cad");
    }
    private async Task downloadRevit()
    {
        await JS.InvokeVoidAsync("downloadRevit");
        await WriteDownloadLog("revit");
    }


    private async Task WriteDownloadLog(string Appname)
    {
        var user = await JS.InvokeAsync<string>("sessionStorage.getItem", "username");
        var log = new LogRequest
        {
            Username = user == null ? "null" : user,
            Action = "_download_",
            App = Appname
        };

        var client = 请求方法.CreateUnsafeClient(); // 自定义不验证证书的 HttpClient
        var response = await client.PostAsJsonAsync(请求方法.UrlIP + "/api/auth/write", log);

        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine($"❌ 日志写入失败: {response.StatusCode}");
        }
    }



    private async Task LoadPluginInfo(string plugin)
    {
        try
        {
            var client = 请求方法.CreateUnsafeClient();
            var response = await client.GetAsync(请求方法.UrlIP + "/api/download/file-info?plugin=" + plugin);
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var info = JsonSerializer.Deserialize<PluginInfo>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (info != null)
                {
                    switch (plugin)
                    {
                        case "cad":
                            cadVersion = info.version;
                            cadUpdateDate = info.creationTime;
                            break;
                        case "rhino":
                            rhinoVersion = info.version;
                            rhinoUpdateDate = info.creationTime;
                            break;
                        case "revit":
                            revitVersion = info.version;
                            revitUpdateDate = info.creationTime;
                            break;
                    }

                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ 获取 {plugin} 插件信息失败: {ex.Message}");
        }
    }

    public class PluginInfo
    {
        public string version { get; set; }
        public string creationTime { get; set; }
    }



    private async void GoToDocs()
    {
        await JS.InvokeVoidAsync("open", "http://192.168.7.194:3000/docs/SX_Cad_插件使用手册/一、产品简介", "_blank");
        //Nav.NavigateTo("http://192.168.7.194:3000/docs", forceLoad: true);
    }
    private async void GoToSXGZL()
    {
        await JS.InvokeVoidAsync("open", "http://192.168.7.194:3000", "_blank");
    }
}
